<html>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js" />
<script type="text/javascript" src="common.js" />
<script>
setDefaults();
var gTimer;
startTimer();

function restartTimer() {
   startTimer(); 
}

function startTimer() {
    if(gTimer) {
        clearInterval(gTimer);
    }
    //gTimer = setInterval(fetchInfo, getPref('refresh_rate')*1000);
    gTimer = setInterval(fetchInfo, 5000);
}

function test() {
    $('#timeleft').html('hi');
}

function fetchInfo() {
    var sabApiUrl = constructApiUrl();
    var data = constructApiPost();
    data.mode = 'qstatus';
    data.output = 'json';
    $.ajax({
        type: "GET",
        url: sabApiUrl,
        data: data,
        dataType: 'json',
        success: function(data) {
            $('#timeleft').html(data.timeleft);
        },
        error: function() {
            // This seems to get called on a success message from sabnzbd.
            
            // error won't have data var
            $('#timeleft').html(data.timeleft);
        }
    });
    
}

function setDefaults() {
    if(!getPref('sab_url')) setPref('sab_url', 'http://localhost:8080/sabnzbd/');
    if(!getPref('api_key')) setPref('api_key', '');
    if(!getPref('sab_user')) setPref('sab_user', '');
    if(!getPref('sab_pass')) setPref('sab_pass', '');
    
    if(!getPref('refresh_rate')) setPref('refresh_rate', 5);
}


// Listen for notifications from the content script.
chrome.extension.onConnect.addListener(function(port, name) {
    port.onMessage.addListener(function(msg) {
        if(msg.get) {
            var value = getPref(msg.get);    
            sendConfigResponse(msg.get, value);
        }
    });
});


function sendConfigResponse(key, value) {
  chrome.tabs.getSelected(null, function(tab) {
    var port = chrome.tabs.connect(tab.id, {name: "notifyChannelOut"});
    port.postMessage({key: key, value: value});
  });
}


</script>
</html>