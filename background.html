<html>
<head>
<!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js" /> -->
  <script type="text/javascript" src="jquery-1.3.2.min.js"></script>
  <script type="text/javascript" src="jquery-ui-1.7.2.sortable.min.js"></script>
  <script type="text/javascript" src="jquery.jqote.min.js"></script>
  <script type="text/javascript" src="common.js"></script>
  <script type="text/javascript" src="js/sabconnect.js"></script>

<script>
var gTimer;
var gSabInfo;

var img_g = chrome.extension.getURL('images/sab2_16_green.png');

console.log('bg load');

$(document).ready(function() {
    setDefaults();
    startTimer();
    console.log('bg ready');
});


function startTimer() {
    if(gTimer) {
        clearInterval(gTimer);
    } else {
        fetchInfo();
    }
    gTimer = setInterval(fetchInfo, getPref('refresh_rate')*1000);
    //gTimer = setInterval(fetchInfo, 5000);
}


function setDefaults() {

    // new user
    if((getPref('sab_url') === undefined) && getPref('daemons') === undefined){

    }else
    // upgrading user
    if (getPref('sab_url') === undefined){
        setPref('refresh_rate', 15);
        setPref('sab_url', 'http://localhost:8080/sabnzbd/');
        setPref('api_key', '');
        setPref('speedlog', []);

        setPref('enable_messenger', 1);
        setPref('show_graph', 0);
        setPref('enable_newzbin', 1);
        setPref('enable_tvnzb', 1);
        setPref('enable_nzbmatrix', 1);
    }

    if(getPref('refresh_rate') === undefined) setPref('refresh_rate', 15);

    if(getPref('daemons') === undefined ) {
        if(! (getPref('sab_url') === undefined)){
            daemons = [{label:'my sabnzbd+',url:getPref('sab_url'),apikey:getPref('api_key')}];
        }else{
            daemons = [{label:'localhost',url:'http://localhost:8080/sabnzbd/',apikey:''}];
        }
        setPref('daemons', daemons);
        active_daemon = daemons[0];
    }else{
        var daemons = getPref('daemons');

        if (daemons.length > 0){
            active_daemon = daemons[0];
        }
    }

}

chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    console.log(sender.tab ?
                "from a content script:" + sender.tab.url :
                "from the extension");
    if (request.greeting == "hello")
      sendResponse({farewell: "goodbye"});
    else
      sendResponse({}); // snub them.
  });

// Listen for notifications from the content script.
chrome.extension.onConnect.addListener(function(port, name) {
    port.onMessage.addListener(function(msg) {
        if(msg.get) {
            var value = getPref(msg.get);    
            sendConfigResponse(msg.get, value);
        }
    });
});


function sendConfigResponse(key, value) {
  chrome.tabs.getSelected(null, function(tab) {
    var port = chrome.tabs.connect(tab.id, {name: "notifyChannelOut"});
    port.postMessage({key: key, value: value});
  });
}


</script>
</head>
<body></body>
</html>